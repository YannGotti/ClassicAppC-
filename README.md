# RPG Game C++ (DEV-3)

## Описание проекта

Это 2D RPG на C++ с использованием **GDI+** для рендеринга и поддержки **pixel-art**.

Проект включает:

* **TileMap** из Tiled (через Tileson)
* **Слои отрисовки** с кэшированием статичных объектов
* **Динамичные сущности** (игрок, монстры, эффекты)
* **Pixel-perfect рендеринг**
* **Камеру** с плавным движением и масштабированием

---

## Структура проекта

```
/src
├─ GameWorld.h / GameWorld.cpp      // Основной мир, камера, загрузка игрока
├─ EntityController.h / cpp         // Управление всеми сущностями
├─ LayerController.h / cpp          // Система слоёв и кэширование
├─ TileMapLoader.h / cpp            // Загрузка Tiled карт и тайлов
├─ Entities/                        // Игрок, монстры, NPC
├─ IRenderable.h                     // Интерфейс для объектов, которые можно рисовать
└─ Main.cpp / WinMain.cpp            // Точка входа и WM_PAINT
```

---

## Основные компоненты

### 1. **GameWorld**

* Загружает карты и сущности
* Управляет камерой и её трансформациями
* Обновляет динамичные объекты
* Рисует мир через `LayerController::DrawAll(g)`

### 2. **EntityController**

* Хранит все сущности (динамические и статичные)
* Поддерживает добавление, удаление, поиск объектов
* Позволяет заменять объекты (например игрока)

### 3. **LayerController**

* Управляет порядком отрисовки объектов через слои (`int layer`)
* Поддерживает **кэширование слоёв**, если в них нет динамичных объектов
* Автоматически помечает слой как `dirty`, если объекты перемещаются или добавляются/удаляются
* Поддерживает `MoveToLayer()` для изменения слоя сущности

**Пример слоёв:**

```
0  — TileMap / фон
10 — декор / деревья / предметы
20 — игрок / монстры
30 — эффекты
40 — UI
```

---

### 4. **TileMapLoader**

* Загружает Tiled проекты и тайлсеты через Tileson
* Реализует `IRenderable`
* Отрисовывается как статичный слой (кэшируется)
* Поддерживает pixel-perfect рендеринг

### 5. **IRenderable**

* Интерфейс для всех объектов, которые можно рисовать
* Методы:

  ```cpp
  virtual void Draw(Gdiplus::Graphics& g) = 0;
  virtual bool IsDynamic() const { return false; }
  ```
* Динамичные объекты (игрок, монстры, эффекты) → `IsDynamic() = true`
* Статичные объекты (карта, декор) → `IsDynamic() = false`

---

## Pixel-perfect рендеринг

Для сохранения чёткости пиксель-арта во всех `Graphics`:

```cpp
g.SetInterpolationMode(InterpolationModeNearestNeighbor);
g.SetSmoothingMode(SmoothingModeNone);
g.SetPixelOffsetMode(PixelOffsetModeNone);
```

Применяется:

* ко всем Graphics в WM_PAINT
* при рендере кэшированных слоёв LayerController

---

## Добавление объектов на слой

```cpp
LayerController::Add(obj, layer);           // добавить объект
LayerController::Remove(obj);               // удалить объект
LayerController::MoveToLayer(obj, newLayer); // переместить объект на другой слой
```

---

## Камера

* Плавное движение (`smoothing`)
* Следит за игроком (`camera.Follow(player)`)
* Поддержка зума (`camera.SetZoom(float)`)
* Применяется ко всем слоям через `camera.ApplyTransform(g)`

---

## Загрузка карты и игрока

```cpp
m_mapLoader.LoadProject(L"TiledMap/map.tiled-project");
LayerController::Add(&m_mapLoader, 0); // карта на нижний слой

Character* player = new Character(x, y);
player->animController.LoadAnimations(L"Assets/Player");
LayerController::Add(player, 20); // игрок на динамичный слой
```

---

## Оптимизация слоёв

* **Статичные слои**: рисуются один раз → кэшируются → каждый кадр просто `DrawImage`
* **Динамичные слои**: рисуются каждый кадр
* Перемещение объекта между слоями → помечает старый и новый слой как dirty

---

## Пример игрового цикла

```cpp
void GameWorld::Update(float deltaTime)
{
    camera.Update();
    
    for (auto* e : EntityController::GetDynamicEntities())
        e->Update(deltaTime);
}

void GameWorld::Draw(Gdiplus::Graphics& g, const RECT& clientRect)
{
    camera.ApplyTransform(g);
    LayerController::DrawAll(g);   // рисует все слои с кэшированием
    Camera::ResetTransform(g, clientRect.right, clientRect.bottom);
}
```

---

## Рендер-пайплайн (ASCII-схема)

```
WM_PAINT
   │
   ▼
+----------------------+
| Graphics g (pixel-perfect)
| InterpolationMode = NearestNeighbor
| SmoothingMode = None
+----------------------+
   │
   ▼
GameWorld::Draw(g)
   │
   ├─ camera.ApplyTransform(g)
   │
   └─ LayerController::DrawAll(g)
          │
          ├─ Layer 0: TileMapLoader (статичный слой)
          │      ├─ cacheBitmap создаётся один раз
          │      ├─ dirty = false
          │      └─ DrawImage(cache) на Graphics
          │
          ├─ Layer 10: Декор (статичный)
          │      └─ кэшируется
          │
          ├─ Layer 20: Игрок / монстры (динамичные)
          │      └─ перерисовывается каждый кадр
          │
          ├─ Layer 30: Эффекты (динамичные)
          │      └─ перерисовывается каждый кадр
          │
          └─ Layer 40: UI
                 └─ перерисовывается каждый кадр
```

---

## Требования

* C++17
* Windows (WinAPI)
* GDI+
* Tileson (для Tiled JSON карт)

---

## ✅ Чеклист текущей реализации

### Основной функционал

* [x] Загрузка Tiled карт через Tileson (`TileMapLoader`)
* [x] Поддержка тайлсетов и изображений для карты
* [x] Отрисовка карты как отдельного слоя через `LayerController`
* [x] Поддержка динамичных сущностей (`Character`, `Goblin`, `Monster`)
* [x] Pixel-perfect рендеринг (`NearestNeighbor`, `SmoothingModeNone`)
* [x] Камера с плавным движением и зумом
* [x] Кэширование статичных слоёв для оптимизации
* [x] Перемещение объектов между слоями (`MoveToLayer`)
* [x] Разделение слоёв: фон, декор, игрок/мобы, эффекты, UI

### LayerController

* [x] Добавление объектов на слой (`Add`)
* [x] Удаление объектов (`Remove`)
* [x] Перемещение между слоями (`MoveToLayer`)
* [x] Кэширование слоёв без динамики
* [x] Автоматическая отметка dirty при изменении слоя

### EntityController

* [x] Хранение всех сущностей
* [x] Добавление, удаление, замена объектов
* [x] Получение динамичных объектов для обновления

### TileMapLoader

* [x] Поддержка статичных слоёв
* [x] Отрисовка тайлов через GDI+ `DrawImage`
* [x] Поддержка кэширования для статичных слоёв

### GameWorld

* [x] Инициализация игрока и загрузка его анимаций
* [x] Обновление динамичных объектов каждый кадр
* [x] Отрисовка мира через `LayerController::DrawAll`
* [x] Применение камеры ко всем слоям

---

## 📝 Чеклист улучшений (TODO)

### 1️⃣ TileMap и слои

* [ ] Разделить TileMap на **статичные** и **динамичные слои**
* [ ] Поддержка **анимированных тайлов** (Tiled Animated Tiles)
* [ ] Возможность **динамического обновления кэша слоя** при изменении тайлов
* [ ] Сортировка тайлов по слою/классу для тайлов “над игроком”

### 2️⃣ LayerController

* [ ] Управление **приоритетами внутри слоя** (сортировка по Y для 2.5D эффекта)
* [ ] Событийное пересоздание кэша: пересоздавать только при изменениях (dirty flag)
* [ ] Отдельное хранение **динамичных объектов** внутри слоя

### 3️⃣ Камера и оптимизация рендера

* [ ] Внедрить **frustum culling** — рендерить только видимые объекты
* [ ] Оптимизация TileMapLoader: не рисовать тайлы вне камеры

### 4️⃣ EntityController и объекты

* [ ] Ввести **категории сущностей**: игрок, NPC, мобы, триггеры, эффекты
* [ ] Добавить **сортировку объектов по Y** для динамичных слоёв

### 5️⃣ Pixel-perfect рендеринг

* [ ] Флаг масштабирования для динамичных объектов, чтобы не размывать пиксели
* [ ] Использовать offscreen render + BitBlt для больших карт

### 6️⃣ Архитектура и код

* [ ] Ввести **событийную систему мира** (объекты подписываются на изменения)
* [ ] Сделать LayerController **шаблонным** на тип объекта (статичные/динамичные слои)
* [ ] Разделить TileMapLoader на:

  * `TileSetManager` — управление тайлсетами
  * `TileLayerRenderer` — рендеринг тайлов
* [ ] Ввести **ResourceManager** для тайлов, анимаций, звуков
* [ ] Использовать `unique_ptr` / `shared_ptr` для сущностей и тайлов

### 7️⃣ Новые фичи

* [ ] Эффекты частиц (огонь, дым)
* [ ] Освещение и тени на тайлах
* [ ] Динамическая карта с интерактивными тайлами (двери, лианы)
* [ ] Поддержка нескольких карт и плавного перехода
* [ ] Сетевой режим (состояние сущностей на сервере)
